{% extends 'emp/base.html' %}
{% load crispy_forms_tags %}
{% load helper %}
{% block content-header %}Job List{% endblock %}
{% block css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<style type="text/css">
  .tab-pane{
    padding-top: 15px;
  }
</style>
{% endblock %}
{% block content %}
{% for message in messages %}
    <div class="text-center alert alert-{{ message.tags }}">
                {{ message|safe }}
            </div>
        {% endfor %}
<br>
<div>
  <div class="d-flex">
    <div >
      {% if job.company.logo %}
    <img class="d-block align-self-center m-2" src="{{ job.company.logo.url|default_if_none:'#' }}" alt="Card image cap" 
    style=" height: 100px;display: inline;">
    {% endif %}
    </div>
    <div>
      <strong>Job Id : </strong>{{job.id}}<br>
      <strong class="mb-1">Job Title : </strong><a href="{% url 'job-detail' slug=job.slug %}" target="_blank">{{ job.title }}</a><br>
      <span><b>Company : </b>   <a href="{% url 'company-detail' slug=job.company.slug %}" target="_blank">{{ job.company.name }}</a><br>{{job.state}} , {{job.city}}</span>
    </div>
    <div ></div>
  </div>
</div>
<div class="row mb-3">
  <div class="col-md-2"><button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#taskModal">Create Mass Mail</button></div>
  <div class="col-md-10 border p-1">
    <span>Some info regarding mass mail.</span>
  </div>
  
  
</div>
<div>
  <nav>
  <div class="nav nav-tabs" id="nav-tab" role="tablist">
    <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-awaiting" type="button" role="tab" aria-controls="nav-home" aria-selected="true">Awaiting Shortlist</button>
    <button class="nav-link" id="nav-profile-tab" data-bs-toggle="tab" data-bs-target="#nav-shortlisted" type="button" role="tab" aria-controls="nav-profile" aria-selected="false">Shortlisted</button>
  </div>
</nav>
<div class="tab-content" id="nav-tabContent">
  <div class="tab-pane fade show active" id="nav-awaiting" role="tabpanel" aria-labelledby="nav-home-tab">
    
    <table class="table table-striped" id="tb-awaiting">
  <thead>
    <tr>
      <th scope="col"><input class="form-check-input" type="checkbox" value="" id="select-all" > <button type="button" class="btn btn-outline-success btn-sm" style="display: none;" id="btn-shortlist" onclick="shortlist_student(this,'{{job.id}}');">Shortlist</button></th>
      <th scope="col">Student</th>
      <th scope="col">Spoken User Id</th>
    </tr>
  </thead>
  <tbody>
    {% for student in students_awaiting %}
    <tr>
      <td><input class="form-check-input select-student" type="checkbox" value="" id="student_{{student.id}}" ></td>
      <td><a href="{% url 'student_profile' pk=student.id  %}">{{student.user.first_name}}</a></td>
      <td>{{student.spk_usr_id}}</td>
    </tr>
  {% empty %}
  {% endfor %}
  </tbody>
</table>
  </div>
  <div class="tab-pane fade" id="nav-shortlisted" role="tabpanel" aria-labelledby="nav-profile-tab">
    <table class="table table-striped pt-3" id="tb-shortlisted">
  <thead>
    <tr>
      <th scope="col">#Sr No.</th>
      <th scope="col">Student</th>
      <th scope="col">Spoken User Id</th>
      <th scope="col">Email</th>
    </tr>
  </thead>
  <tbody>
    {% for student in students_shortlisted %}
    <tr>
      <td>{{forloop.counter}}</td>
      <td><a href="{% url 'student_profile' pk=student.id  %}">{{student.user.first_name}}</a></td>
      <td>{{student.spk_usr_id}}</td>
      <td>{{student.user.email}}</td>
    </tr>
  {% empty %}
  {% endfor %}
  </tbody>
</table>
  </div>
</div>
</div>

<!-- Modal -->
<center>
  <div class="modal fade" id="taskModal" tabindex="-1" role="dialog" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="exampleModalTitle">Subject:</h4>
        </div>
        <div class="modal-body">
          <form method='post' action="">
          {% csrf_token %}
            <div class="form-group">
              <label for="recipient-name" class="control-label">Subject:</label>
              <input type="text" class="form-control" id="task_subject" name = "task_subject" required>
            </div>
            <div class="form-group">
              <label for="job-id" class="control-label">Job Id:</label>
              <input type="text" class="form-control" id="task_job" name = "task_job" required>
            </div>
            <div class="form-group">
              <label for="message-text" class="control-label">Message:</label>
              <textarea class="form-control" id="task_message" name = "task_message"></textarea>
            </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary " id ="task_submit" onclick="send_mass_mail(event)">Create</button>
          </div>
        </div>
        </form>
        </div>
      </div>
    </div>
  </div>
  </center>
{% endblock %}

{% block js %}
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>

<script type = "text/javascript">

  var tb_s;
  var tb_a;
  function shortlist_student(apply_btn,job_id){
    apply_btn_id = apply_btn.id;
    var student_ids = [];
    var students = '';
        $('input.select-student:checked').each(function() {
          id = $(this).attr("id");
          students+=id.split('_')[1]+','
     });
    $.ajax({
      url: "/shortlist_student",
      data: {
        'job_id' : job_id,
        'students' : students,
      },
      dataType: 'json',
      success:function(data){
        var messages = data.msg
        id=apply_btn_id.split('_');
        if (data.updated==true) {
          location.reload();
        }
    }});
  }
    $(document).ready(function (){
      tb_s = $('#tb-shortlisted').DataTable();  
      tb_a = $('#tb-awaiting').DataTable();

      var selected = [];

    $('#select-all').change(function() {
      
        if(this.checked) {
            $(':checkbox').prop('checked', true);
            $('#btn-shortlist').show();
        }else{
          $(':checkbox').prop('checked', false);
          $('#btn-shortlist').hide();
        }
        $('#textbox1').val(this.checked);        
    });
    $('input.select-student:checkbox').change(function() {
        var allVals = [];
        $('input.select-student:checked').each(function() {
          console.log('here');
       allVals.push($(this).val());
     });
        if (allVals.length) {
          $('#btn-shortlist').show();
          var x = document.getElementsByClassName("select-student");
          if (allVals.length==x.length) {
            $(':checkbox').prop('checked', true);
          };
          
        }else{
          $('#btn-shortlist').hide();
          $('#select-all:checkbox').prop('checked', false);
        }
     $('#t').val(allVals);
    });
});
</script>
<script>
function send_mass_mail(event) {
        event.preventDefault()
        table = $('#tb-shortlisted').DataTable()
        if (table.data().any() == false){
          alert('Email list is empty. Please filter emails for mass mail.')
          return
        }
         
        emails = table.column(3).data()
        data = []
        for (i = 0; i < emails.length; i++) {
              data.push([emails[i]])
            }
      modal = $('#taskModal').modal()
      subject = modal.find('.modal-body input[name="task_subject"]').val()
      job = modal.find('.modal-body input[name="task_job"]').val()
      message = CKEDITOR.instances['task_message'].getData()
      data = JSON.stringify({ 'data': data });
      $.post('http://beta.spoken-tutorial.org/cron/upload_task/',{'subject': subject,'job': job, 'message': message, 'data': data},
      function(success_url) {
        window.location = success_url
        }
      );
      }
</script>
<script type="text/javascript" src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
<script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
<script>
  // Replace the <textarea id="editor1"> with a CKEditor
  // instance, using default configuration.
  CKEDITOR.replace( 'task_message' );
</script>
{% endblock %}


